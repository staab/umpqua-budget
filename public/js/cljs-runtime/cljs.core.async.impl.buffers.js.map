{"version":3,"file":"cljs.core.async.impl.buffers.js","sources":["cljs/core/async/impl/buffers.cljs"],"mappings":"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","names":["buf","arr","new-arr","keep?","v","tail","head","js/Error","n","length","itm","_","cnt","this","js/cljs","js/cljs.core","js/cljs.core.async","js/cljs.core.async.impl","js/cljs.core.async.impl.buffers","js/cljs.core.async.impl.buffers.NO-VAL","cljs.core.async.impl.buffers/NO-VAL","js/Object","new-arr-size","cljs.core.async.impl.buffers/promise-buffer","val","cljs.core.async.impl.buffers/acopy","cljs.core.async.impl.buffers/RingBuffer","js/Array","cljs.core.async.impl.buffers/DroppingBuffer","cljs.core.async.impl.buffers/ring-buffer","x","cljs.core.async.impl.buffers/undelivered?","cljs.core/PROTOCOL_SENTINEL","this__4192__auto__","writer__4193__auto__","opt__4194__auto__","cljs.core/-write","cljs.core.async.impl.buffers/PromiseBuffer","cljs.core.async.impl.buffers/->PromiseBuffer","cljs.core.async.impl.buffers/->RingBuffer","cljs.core.async.impl.buffers/fixed-buffer","dest","src","src-start","n__4408__auto__","cljs.core.async.impl.buffers/SlidingBuffer","cljs.core.async.impl.buffers/->SlidingBuffer","cljs.core.async.impl.buffers/dropping-buffer","dest-start","len","cljs.core.async.impl.buffers/sliding-buffer","cljs.core.async.impl.buffers/FixedBuffer","cljs.core.async.impl.buffers/->FixedBuffer","cljs.core.async.impl.buffers/->DroppingBuffer"],"sourcesContent":[";;   Copyright (c) Rich Hickey and contributors. All rights reserved.\n;;   The use and distribution terms for this software are covered by the\n;;   Eclipse Public License 1.0 (http://opensource.org/licenses/eclipse-1.0.php)\n;;   which can be found in the file epl-v10.html at the root of this distribution.\n;;   By using this software in any fashion, you are agreeing to be bound by\n;;   the terms of this license.\n;;   You must not remove this notice, or any other, from this software.\n\n(ns cljs.core.async.impl.buffers\n  (:require [cljs.core.async.impl.protocols :as impl]))\n\n;; -----------------------------------------------------------------------------\n;; DO NOT USE, this is internal buffer representation\n\n(defn acopy [src src-start dest dest-start len]\n  (loop [cnt 0]\n    (when (< cnt len)\n      (aset dest\n            (+ dest-start cnt)\n            (aget src (+ src-start cnt)))\n      (recur (inc cnt)))))\n\n(deftype RingBuffer [^:mutable head ^:mutable tail ^:mutable length ^:mutable arr]\n  Object\n  (pop [_]\n    (when-not (zero? length)\n      (let [x (aget arr tail)]\n        (aset arr tail nil)\n        (set! tail (js-mod (inc tail) (alength arr)))\n        (set! length (dec length))\n        x)))\n\n  (unshift [_ x]\n    (aset arr head x)\n    (set! head (js-mod (inc head) (alength arr)))\n    (set! length (inc length))\n    nil)\n\n  (unbounded-unshift [this x]\n    (if (== (inc length) (alength arr))\n      (.resize this))\n    (.unshift this x))\n\n  ;; Doubles the size of the buffer while retaining all the existing values\n  (resize\n    [_]\n    (let [new-arr-size (* (alength arr) 2)\n          new-arr (make-array new-arr-size)]\n      (cond\n       (< tail head)\n       (do (acopy arr tail new-arr 0 length)\n           (set! tail 0)\n           (set! head length)\n           (set! arr new-arr))\n\n       (> tail head)\n       (do (acopy arr tail new-arr 0 (- (alength arr) tail))\n           (acopy arr 0 new-arr (- (alength arr) tail) head)\n           (set! tail 0)\n           (set! head length)\n           (set! arr new-arr))\n\n       (== tail head)\n       (do (set! tail 0)\n           (set! head 0)\n           (set! arr new-arr)))))\n\n  (cleanup [this keep?]\n    (dotimes [x length]\n      (let [v (.pop this)]\n        (when ^boolean (keep? v)\n          (.unshift this v))))))\n\n(defn ring-buffer [n]\n  (assert (> n 0) \"Can't create a ring buffer of size 0\")\n  (RingBuffer. 0 0 0 (make-array n)))\n\n;; -----------------------------------------------------------------------------\n\n(deftype FixedBuffer [buf n]\n  impl/Buffer\n  (full? [this]\n    (== (.-length buf) n))\n  (remove! [this]\n    (.pop buf))\n  (add!* [this itm]\n    (.unbounded-unshift buf itm)\n    this)\n  (close-buf! [this])\n  cljs.core/ICounted\n  (-count [this]\n    (.-length buf)))\n\n(defn fixed-buffer [n]\n  (FixedBuffer. (ring-buffer n) n))\n\n(deftype DroppingBuffer [buf n]\n  impl/UnblockingBuffer\n  impl/Buffer\n  (full? [this]\n    false)\n  (remove! [this]\n    (.pop buf))\n  (add!* [this itm]\n    (when-not (== (.-length buf) n)\n      (.unshift buf itm))\n    this)\n  (close-buf! [this])\n  cljs.core/ICounted\n  (-count [this]\n    (.-length buf)))\n\n(defn dropping-buffer [n]\n  (DroppingBuffer. (ring-buffer n) n))\n\n(deftype SlidingBuffer [buf n]\n  impl/UnblockingBuffer\n  impl/Buffer\n  (full? [this]\n    false)\n  (remove! [this]\n    (.pop buf))\n  (add!* [this itm]\n    (when (== (.-length buf) n)\n      (impl/remove! this))\n    (.unshift buf itm)\n    this)\n  (close-buf! [this])\n  cljs.core/ICounted\n  (-count [this]\n    (.-length buf)))\n\n(defn sliding-buffer [n]\n  (SlidingBuffer. (ring-buffer n) n))\n\n(defonce ^:private NO-VAL (js/Object.))\n(defn- undelivered? [val]\n  (identical? NO-VAL val))\n\n(deftype PromiseBuffer [^:mutable val]\n  impl/UnblockingBuffer\n  impl/Buffer\n  (full? [_]\n    false)\n  (remove! [_]\n    val)\n  (add!* [this itm]\n    (when (undelivered? val)\n      (set! val itm))\n    this)\n  (close-buf! [_]\n    (when (undelivered? val)\n      (set! val nil)))\n  cljs.core/ICounted\n  (-count [_]\n    (if (undelivered? val) 0 1)))\n\n(defn promise-buffer []\n  (PromiseBuffer. NO-VAL))\n"]}