{"version":3,"file":"wedge.client.ws.js","sources":["wedge/client/ws.cljs"],"mappings":";;;AAGA,AAAKA,qBAAG,6CAAA,7CAACC;AACT,AAAKC,wBAAM,6CAAA,7CAACD;AAIZ,6BAAA,7BAAME,kEAAOC,KAAKC;AAAlB,AACE,OAACC,mDACCJ,sBACA,WAAKK;AAAL,AACE,IAAMC,eAAa,AAACC,6CAAKF,SAAS,wGAAA,2CAAA,0DAAA,7MAACG,wMAAcN,gEAAcC;AAA/D,AACE,oBAAA,AAAAM,gBAAKX;AACH,AAAI,oBAAA,pBAACa;kBAADD;AAAA,AAAO,OAAA,AAAAD,yCAAAC,zBAAQZ;;CAAMQ;;AAAzB;;AACAD;;;;AAIV,GAAA,QAAAO,kCAAAC,yCAAAC,4CAAAC;AAAA;AAAA,AAAA,iCAAA,iBAAAC,6BAAA,AAAAjB,6CAAA,5HAAU0B;IAAVR,6BAAA,AAAAlB,6CAAA;IAAAmB,6BAAA,AAAAnB,6CAAA;IAAAoB,iCAAA,AAAApB,6CAAA;IAAAqB,0BAAA,AAAAC,4CAAA,mCAAA,gEAAA,AAAAC;AAAA,AAAA,YAAAC,kBAAA,AAAAC,+CAAA,kBAAA,kBAAA,qDAAA,4DAAAJ,wBAAAJ,2BAAAC,2BAAAC,2BAAAC;;;AAIA,6BAAA,7BAAMO,kEAAYC;AAAlB,AACE,qGAAA,rGAACC,wHAAuB,AAAQD;;AAChC,IAAAE,WAAgB,AAACC,sDAAwB,AAAQH;AAAjD,AAAA,oIAAAE,qDAAAA,jLAACJ,+DAAAA,yEAAAA;;AAEH,iCAAA,jCAAMM;AAAN,AACE,IAAAC,2BAAA,AAAAvB,gBAAmBX;AAAnB,AAAA,oBAAAkC;AAAA,AAAA,mBAAAA,fAAWC;AAAX,AAAuB,AAAQA;;AAA/B;;AACA,IAAMC,SAAO,KAAAC,UAAA;AAAb,AACE,wBAAA,OAAA,/BAAmBD;;AAAnB,AAAkC,OAACE,sBAAOtC,mBAAGoC;;;;AAC7C,wBAAA,xBAAmBA,kCAAiBR;;AACpC,+BAAA,QAAA,hCAAmBQ;;AAAnB,AAAmC,gDAAA,zCAACE,sBAAOtC;;;;AAE/C,YAAA,ZAACuC;AAAD,AAAiB,GAAM,CAAA,AAAA5B,uCAAA,vBAAOX;AAAb,AAAiB,OAACiC;;AAAlB;;GAAjB","names":["wedge.client.ws/ws","cljs.core.atom.cljs$core$IFn$_invoke$arity$1","wedge.client.ws/queue","wedge.client.ws/send!","type","payload","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$2","messages","all-messages","cljs.core.conj.cljs$core$IFn$_invoke$arity$2","cljs.core.pr_str.cljs$core$IFn$_invoke$arity$variadic","cljs.core/deref","p1__10763#","cljs.core/run!","js/wedge","js/wedge.client","js/wedge.client.ws","js/wedge.client.ws.handle-message","method-table__4414__auto__","prefer-table__4415__auto__","method-cache__4416__auto__","cached-hierarchy__4417__auto__","hierarchy__4418__auto__","cljs.core.get.cljs$core$IFn$_invoke$arity$3","cljs.core/get-global-hierarchy","cljs.core/MultiFn","cljs.core.symbol.cljs$core$IFn$_invoke$arity$2","wedge.client.ws/handle-message","wedge.client.ws/on-message","evt","cljs.core.prn.cljs$core$IFn$_invoke$arity$variadic","G__10779","cljs.reader.read_string.cljs$core$IFn$_invoke$arity$1","wedge.client.ws/start-ws!","temp__5457__auto__","old-ws","socket","js/WebSocket","cljs.core/reset!","js/setInterval"],"sourcesContent":["(ns wedge.client.ws\n  (:require [cljs.reader :refer [read-string]]))\n\n(def ws (atom nil))\n(def queue (atom []))\n\n;; Outgoing\n\n(defn send! [type payload]\n  (swap!\n    queue\n    (fn [messages]\n      (let [all-messages (conj messages (pr-str {:type type :payload payload}))]\n        (if @ws\n          (do (run! #(.send @ws %) all-messages) [])\n          messages)))))\n\n;; Incoming\n\n(defmulti handle-message :type)\n\n;; Websocket setup\n\n(defn on-message [evt]\n  (prn \"Handling message\" (.-data evt))\n  (handle-message (cljs.reader/read-string (.-data evt))))\n\n(defn start-ws! []\n  (when-let [old-ws @ws] (.close old-ws))\n  (let [socket (js/WebSocket. \"ws://localhost:5000\")]\n    (.addEventListener socket \"open\" #(reset! ws socket))\n    (.addEventListener socket \"message\" on-message)\n    (.addEventListener socket \"close\" #(reset! ws nil))))\n\n(js/setInterval #(when (nil? @ws) (start-ws!)) 1000)\n"]}