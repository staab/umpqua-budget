{"version":3,"sources":["wedge/client/ws.cljs"],"mappings":";;;AAGA,AAAKA,AAAG,AAAA,AAACC;AACT,AAAKC,AAAM,AAAA,AAACD;AAIZ,AAAA,AAAME,AAAOC,AAAKC;AAAlB,AACE,AAACC,AACCJ,AACA,AAAKK;AAAL,AACE,AAAMC,AAAa,AAACC,AAAKF,AAAS,AAAA,AAAA,AAAA,AAACG,AAAcN,AAAcC;AAA/D,AACE,AAAA,AAAAM,AAAKX;AACH,AAAI,AAAA,AAACa;AAADD;AAAA,AAAO,AAAA,AAAAD,AAAAC,AAAQZ;;AAAMQ;;AAAzB;;AACAD;;;;AAIV,AAAA,AAAAO,AAAAC,AAAAC,AAAAC;AAAA;AAAA,AAAA,AAAA,AAAAC,AAAA,AAAAjB,AAAA,AAAU0B;AAAVR,AAAA,AAAAlB,AAAA;AAAAmB,AAAA,AAAAnB,AAAA;AAAAoB,AAAA,AAAApB,AAAA;AAAAqB,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAAC,AAAA;AAAA,AAAA,AAAAA,AAAAA,AAAAA;;AAAA,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAAJ,AAAAJ,AAAAC,AAAAC,AAAAC;;;AAIA,AAAA,AAAMO,AAAYC;AAAlB,AACE,AAAA,AAACC,AAAuB,AAAQD;;AAChC,AAAAE,AAAgB,AAACC,AAAwB,AAAQH;AAAjD,AAAA,AAAAE,AAAAA,AAACJ,AAAAA,AAAAA;;AAEH,AAAA,AAAMM;AAAN,AACE,AAAAC,AAAA,AAAAvB,AAAmBX;AAAnB,AAAA,AAAAkC;AAAA,AAAA,AAAAA,AAAWC;AAAX,AAAuB,AAAQA;;AAA/B;;AACA,AAAMC,AAAO,AAAAC,AAAA;AAAb,AACE,AAAA,AAAA,AAAmBD;;AAAnB,AAAkC,AAACE,AAAOtC,AAAGoC;;;;AAC7C,AAAA,AAAmBA,AAAiBR;;AACpC,AAAA,AAAA,AAAmBQ;;AAAnB,AAAmC,AAAA,AAACE,AAAOtC;;;;AAE/C,AAAA,AAACuC;AAAD,AAAiB,AAAM,AAAA,AAAA5B,AAAA,AAAOX;AAAb,AAAiB,AAACiC;;AAAlB;;AAAjB","names":["wedge.client.ws/ws","cljs.core.atom.cljs$core$IFn$_invoke$arity$1","wedge.client.ws/queue","wedge.client.ws/send!","type","payload","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$2","messages","all-messages","cljs.core.conj.cljs$core$IFn$_invoke$arity$2","cljs.core.pr_str.cljs$core$IFn$_invoke$arity$variadic","cljs.core/deref","p1__36011#","cljs.core/run!","js/wedge","js/wedge.client","js/wedge.client.ws","js/wedge.client.ws.handle-message","method-table__4613__auto__","prefer-table__4614__auto__","method-cache__4615__auto__","cached-hierarchy__4616__auto__","hierarchy__4617__auto__","cljs.core.get.cljs$core$IFn$_invoke$arity$3","fexpr__36012","cljs.core/MultiFn","cljs.core.symbol.cljs$core$IFn$_invoke$arity$2","wedge.client.ws/handle-message","wedge.client.ws/on-message","evt","cljs.core.prn.cljs$core$IFn$_invoke$arity$variadic","G__36013","cljs.reader.read_string.cljs$core$IFn$_invoke$arity$1","wedge.client.ws/start-ws!","temp__5720__auto__","old-ws","socket","js/WebSocket","cljs.core/reset!","js/setInterval"],"sourcesContent":["(ns wedge.client.ws\n  (:require [cljs.reader :refer [read-string]]))\n\n(def ws (atom nil))\n(def queue (atom []))\n\n;; Outgoing\n\n(defn send! [type payload]\n  (swap!\n    queue\n    (fn [messages]\n      (let [all-messages (conj messages (pr-str {:type type :payload payload}))]\n        (if @ws\n          (do (run! #(.send @ws %) all-messages) [])\n          messages)))))\n\n;; Incoming\n\n(defmulti handle-message :type)\n\n;; Websocket setup\n\n(defn on-message [evt]\n  (prn \"Handling message\" (.-data evt))\n  (handle-message (cljs.reader/read-string (.-data evt))))\n\n(defn start-ws! []\n  (when-let [old-ws @ws] (.close old-ws))\n  (let [socket (js/WebSocket. \"ws://localhost:5000\")]\n    (.addEventListener socket \"open\" #(reset! ws socket))\n    (.addEventListener socket \"message\" on-message)\n    (.addEventListener socket \"close\" #(reset! ws nil))))\n\n(js/setInterval #(when (nil? @ws) (start-ws!)) 1000)\n"]}